<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="referrer" content="no-referrer">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://html2canvas.hertzen.com https://cdn.jsdelivr.net https://gc.zgo.at https://static.cloudflareinsights.com 'unsafe-inline'; style-src 'self' https://cdnjs.cloudflare.com 'unsafe-inline'; font-src 'self' https://cdnjs.cloudflare.com; img-src 'self' data: https://gc.zgo.at https://cdn.jsdelivr.net; connect-src 'self' https://linsnotes.goatcounter.com https://docs.google.com https://*.googleusercontent.com; object-src 'none'; base-uri 'self';">
    <title>Language Puzzle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11" crossorigin="anonymous"></script>
    <script data-goatcounter="https://linsnotes.goatcounter.com/count" async src="https://gc.zgo.at/count.v4.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" crossorigin="anonymous"></script>
    
    <style>
        /* Base Styles (Same as your original CSS, but repeated for clarity) */
        :root {
            --primary: #1a73e8; /* Modern blue color (Google style) */
            --primary-hover: #0b5fdb; /* Darker shade for hover */
            --secondary: #e5e7eb;
            --accent: #8b5cf6;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --light: #f9fafb;
            --dark: #111827;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.5rem;
            --transition: all 0.3s ease;

            /* --- NEW: Font configuration for word boxes --- */
            /* Default font stack: Prioritizes system UI fonts, common web fonts, and a generic fallback. */
            /* You can CHANGE this stack to better suit the primary languages you expect. */
            /* Example for primarily CJK languages: */
            /* --word-box-font-family: 'Noto Sans SC', 'Noto Sans TC', 'Noto Sans JP', 'Noto Sans KR', 'Microsoft YaHei', 'SimHei', 'Malgun Gothic', Meiryo, sans-serif; */
            /* Example for primarily Thai: */
            /* --word-box-font-family: 'Noto Sans Thai', Tahoma, sans-serif; */
            --word-box-font-family: KaiTi,             /* Windows Simplified */
                                    'Kaiti SC',         /* macOS/iOS Simplified */
                                    DFKai-SB,           /* Windows Traditional */
                                    BiauKai,            /* Common Traditional */
                                    'Microsoft YaHei',  /* Common Sans Chinese Fallback (optional but good) */
                                    'SimHei',           /* Common Sans Chinese Fallback (optional but good) */
                                    'Segoe UI',        /* Standard Latin Sans */
                                    Roboto,             /* Standard Latin Sans (Android/ChromeOS) */
                                    'Helvetica Neue',   /* Standard Latin Sans (macOS/iOS) */
                                    Arial,              /* Widely available Latin Sans */
                                    sans-serif;         /* Generic fallback */


            /* Default font size for word boxes. Adjust as needed. */
            --word-box-font-size: 1.5rem; /* <-- EDIT THIS LINE TO CHANGE SIZE GLOBALLY */
            /* --- End NEW --- */
           
        }
        
    /* Rotating icon animation */
    .rotate-icon {
        display: inline-block;
        animation: spin 3s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Text fill effect */
    .fill-text {
        display: inline-block;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        background-size: 200% 100%;
        -webkit-background-clip: text;
        color: transparent;
        animation: fillText 5s ease infinite;
    }

    @keyframes fillText {
        from {
            background-position: -100% 0;
        }
        to {
            background-position: 0 0;
        }
    }


/* Typography */
    body {
        font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f3f4f6;
        color: var(--text-primary);
        line-height: 1.5;
    }

    h1, h2, h3, h4, h5, h6 {
        font-weight: 600;
        margin-top: 0;
        color: var(--dark);
    }

    h1 {
        font-size: 2rem;
        margin-bottom: 1.5rem;
    }

    h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }

    /* Layout */
    .app-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 1rem;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .app-header {
        text-align: center;
        padding: 1rem 0;
        border-bottom: 1px solid var(--secondary);
        margin-bottom: 2rem;
    }

    .app-footer {
        margin-top: auto;
        text-align: center;
        padding: 1rem 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
        border-top: 1px solid var(--secondary);
    }

    .app-footer a {
        color: #6b7280; /* Gray color */
        text-decoration: none;
    }

    /* Cards and Screens */
    .screen {
        display: none;
        opacity: 0;
        transition: var(--transition);
        transform: translateY(10px);
    }

    .screen.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .card {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 2rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
    }

    .card-header {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--secondary);
        padding-bottom: 1rem;
    }

    .card-title {
        font-size: 1.25rem;
        margin: 0;
    }

    .card-body {
        margin-bottom: 1.5rem;
    }

    .card-footer {
        border-top: 1px solid var(--secondary);
        padding-top: 1rem;
        display: flex;
        justify-content: center; /* Center all buttons in card footer */
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    /* Form Elements */
    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        display: block;
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid var(--secondary);
        border-radius: var(--radius);
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }

    /* Quiz ID input specific styling */
    #quizId, #userName {
        width: 100%;
        box-sizing: border-box;
        margin: 0;
        padding: 0.75rem;
    }

    /* Fix alignment for the quiz ID container */
    .form-group {
        padding: 0;
        margin-bottom: 1.5rem;
    }

    .center-button {
    text-align: center;
    }

    /* Buttons */
    .btn {
        display: inline-block;
        font-weight: 500;
        text-align: center;
        vertical-align: middle;
        user-select: none;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: var(--radius);
        transition: var(--transition);
        cursor: pointer;
        border: none;
    }

    .btn-primary {
        background-color: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background-color: var(--primary-hover);
    }

    .btn-secondary {
        background-color: var(--secondary);
        color: var(--text-primary);
    }

    .btn-secondary:hover {
        background-color: #d1d5db;
    }

    .btn-success {
        background-color: var(--success);
        color: white;
    }

    .btn-success:hover {
        background-color: #0ca678;
    }

    .btn-danger {
        background-color: var(--danger);
        color: white;
    }

    .btn-danger:hover {
        background-color: #dc2626;
    }

    .btn-lg {
        padding: 1rem 2rem;
        font-size: 1.125rem;
    }

    .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }

    /* Quiz Elements */
    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .timer-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        background: var(--light);
        border-radius: var(--radius);
    }

    .timer-container i {
        color: var(--primary);
    }

    .timer-value {
        color: var(--text-primary);
    }

    .quiz-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 0.5rem 1rem;
    background: var(--light);
    border-radius: var(--radius);
    }

    .question-counter {
        font-weight: 500;
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        background: var(--light);
        border-radius: var(--radius);
    }

    .quiz-instructions {
        margin-bottom: 1.5rem;
        padding: 0.75rem;
        background-color: rgba(26, 115, 232, 0.1);
        border-left: 4px solid var(--primary);
        border-radius: 0 var(--radius) var(--radius) 0;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }

    /* Word Containers */
    .drop-zone {
        min-height: 80px;
        border: 2px dashed #d1d5db;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background: #f9fafb;
        border-radius: var(--radius);
        transition: var(--transition);
    }

    .drop-zone:hover {
        border-color: var(--primary);
    }

    .drop-zone-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .word-box {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        background: white;
        border-radius: var(--radius);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        cursor: move;
        user-select: none;
        transition: var(--transition);
        border: 1px solid #e5e7eb;
        /* --- APPLY FONT VARIABLES --- */
        font-family: var(--word-box-font-family); /* Use the variable */
        font-size: var(--word-box-font-size);   /* Use the variable */
        /* --- End APPLY --- */
    }

    .word-box:hover {
        background: #f3f4f6;
        transform: translateY(-2px);
    }

    .word-box.dragging {
        opacity: 0.6;
        background: rgba(26, 115, 232, 0.2); /* Light blue fill */
        border-color: var(--primary);
    }

    /* Results Screen */
    .result-summary {
        padding: 1.5rem;
        background-color: #f3f4f6;
        border-radius: var(--radius);
        margin-bottom: 1.5rem;
    }

    .result-stat {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .result-stat i {
        margin-right: 0.75rem;
        color: var(--primary);
        width: 24px;
        text-align: center;
    }

    .results-table-container {
        overflow-x: auto;
        margin-bottom: 1.5rem;
    }

    .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .results-table th,
    .results-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid var(--secondary);
    }

    .results-table th {
        background-color: #f9fafb;
        font-weight: 600;
        color: var(--text-secondary);
    }

    .results-table tr:hover td {
        background-color: #f3f4f6;
    }

    /* Divider and alternative option styling */
    .divider {
        display: flex;
        align-items: center;
        margin: 1.5rem 0;
        color: var(--text-secondary);
        font-size: 0.875rem;
    }

    .divider::before,
    .divider::after {
        content: "";
        flex: 1;
        border-bottom: 1px solid var(--secondary);
    }

    .divider::before {
        margin-right: 1rem;
    }

    .divider::after {
        margin-left: 1rem;
    }

    /* Progress bar for quiz */
    .progress-container {
        width: 100%;
        height: 6px;
        background-color: var(--secondary);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 1.5rem;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--primary);
        transition: width 0.3s ease;
    }

    /* Correct/Incorrect Styling */
    .word-box.correct {
        background-color: var(--success);
        color: white;
    }

    .word-box.incorrect {
        background-color: var(--danger);
        color: white;
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .card {
            padding: 1.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
        }

        .quiz-header {
            flex-direction: column;
            align-items: flex-start;
            width: 100%;
        }

        .timer-container, .question-counter {
            width: 100%;
            box-sizing: border-box;
            margin: 0.25rem 0;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .results-table th,
        .results-table td {
            padding: 0.5rem;
            font-size: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .app-header h1 {
            margin-bottom: 0.75rem; /* Smaller gap below h1 on mobile */
        }

        .card-footer {
            justify-content: center;
        }

        .btn {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .word-box {
            padding: 0.375rem 0.75rem;
            margin: 0.125rem;
            font-size: 0.875rem;
        }
        
        .quiz-title {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        }
    }

    /* Google Sheet Dropdown Styling */
    #quizSelect {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid var(--secondary);
        border-radius: var(--radius);
        transition: var(--transition);
        background-color: white;
        color: var(--text-primary);
        appearance: none; /* Remove default arrow in some browsers */
        -webkit-appearance: none; /* Remove default arrow in Chrome/Safari */
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236b7280'%3E%3Cpath d='M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem top 50%;
        background-size: 1.25rem;
    }

    #quizSelect:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
    }
</style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1><i class="fas fa-puzzle-piece rotate-icon"></i> 
                <span class="fill-text">Language Puzzle</span>
            </h1>
        </header>

    <!-- Landing Screen -->
    <div id="landingScreen" class="screen active">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Welcome to Language Puzzle</h2>
                <p>Piece together the perfect sentence—every word has its place!</p>
            </div>
            <div class="card-body">
                <!-- Quiz Selection -->
                <div class="form-group">
                    <label for="quizSelect" class="form-label">Built-in Quiz:</label>
                    <select id="quizSelect" class="form-control"></select>
                </div>
                <div class="center-button">
                    <button onclick="startSelectedQuiz()" class="btn btn-primary">
                        <i class="fas fa-play-circle"></i> Start Built-in Quiz
                    </button>
                </div>
                <div class="divider">OR</div>

                <div class="form-group">
                    <label for="quizId" class="form-label">Have a custom quiz?</label>
                    <p class="form-text" style="margin-top: 0.25rem; margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                        <i class="fas fa-info-circle"></i> Custom Quiz ID is provided by your teacher
                    </p>
                    <input type="text" id="quizId" placeholder="Enter Quiz ID" class="form-control">
                </div>
            </div>
            <div class="center-button">
                <button onclick="startCustomQuiz()" class="btn btn-secondary">
                    <i class="fas fa-file-import"></i> Start Custom Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Name Screen -->
    <div id="nameScreen" class="screen">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Let's Get Started</h2>
            </div>
            <div class="quiz-instructions">
                <i class="fas fa-info-circle"></i> Drag and drop the words into the correct order. Double-tap or double-click as an alternative.
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="userName" class="form-label">Enter Your Name</label>
                    <input type="text" id="userName" required class="form-control" placeholder="Your Name">
                </div>
            </div>
            <div class="card-footer">
                <button onclick="startQuiz()" class="btn btn-primary">
                    <i class="fas fa-arrow-right"></i> Start Quiz
                </button>
                <button onclick="showScreen('landingScreen')" class="btn btn-secondary">
                    <i class="fas fa-home"></i> Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quizScreen" class="screen">
        <div class="card">
            <div class="quiz-header">
                <div class="timer-container">
                    <i class="fas fa-clock"></i>
                    Time: <span id="timer" class="timer-value">0</span>s
                </div>
                <div id="quizTitleDisplay" class="quiz-title">
                 <!-- Quiz title will be shown here -->
                </div>
                <div class="question-counter" id="questionNumber"></div>
            </div>
            <div id="progressContainer" class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            <div class="quiz-instructions">
                <i class="fas fa-info-circle"></i> Drag and drop the words into the correct order. Double-tap or double-click as an alternative.
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="drop-zone-label">Available Words:</label>
                    <div id="wordContainer" class="drop-zone"></div>
                </div>
                <div class="form-group">
                    <label class="drop-zone-label">Your Answer:</label>
                    <div class="drop-zone" id="answerZone"></div>
                </div>
            </div>
            <div class="card-footer">
                <button onclick="checkAnswer()" class="btn btn-primary">
                    <i class="fas fa-check-circle"></i> Confirm Answer
                </button>
            </div>
        </div>
    </div>

    <!-- Results Screen -->
    <div id="resultsScreen" class="screen">
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Quiz Results</h2>
            </div>
            <div class="card-body">
                <div class="result-summary" id="resultSummary">
                    <!-- Results summary will be inserted here -->
                </div>

                <div class="results-table-container">
                    <table id="resultsTable" class="results-table">
                        <!-- Results table will be inserted here -->
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <button onclick="screenshotResults()" class="btn btn-secondary">
                    <i class="fas fa-camera"></i> Screenshot Results
                </button>
                <button onclick="reviewQuestions()" class="btn btn-primary">
                    <i class="fas fa-redo"></i> Try Again
                </button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <div id="visitor-counter">
           Welcome! You're visitor #<span id="pageviews">Loading...</span>
        </div>
        <p><a href="https://linsnotes.com">linsnotes.com</a></p>
    </footer>
</div>
<script>
    let currentQuestion = 0;
    let quizData = [];
    let userData = { name: '', startTime: 0, attempts: [], totalPoints: 0 };
    let timerInterval;
    let timerPaused = false;
    let elapsedTime = 0;
    let pausedAt = 0;
    const QUIZ_LIST_SHEET_ID = '1jsmk781Fob4qrAd61DrBDyJQQ0beEFF92yA3uWr7UII'; // Explicitly define quiz list sheet ID
    let questionAttempts = {};
    let quizTitlesAndIds = [];
    let currentSheetId = ''; // Track the current sheet ID, start empty

    // Initialize SortableJS instances
    let sortableWordContainer;
    let sortableAnswerZone;

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize SortableJS for wordContainer
        sortableWordContainer = Sortable.create(document.getElementById('wordContainer'), {
                group: 'shared', // Allows dragging between the two lists
                animation: 0,    // Disable smooth animations
                easing: "linear",
                swapThreshold: 0.7,
                ghostClass: 'dragging', // Apply this class to the ghost element while dragging
                onAdd: function (evt) {
                        // Animate word box on drop
                        evt.item.classList.add('animate-drop');
                        setTimeout(() => evt.item.classList.remove('animate-drop'), 300);
                        // If the item being added back had the 'incorrect' class, remove it immediately.
                        evt.item.classList.remove('incorrect');
                }
        });

        // Initialize SortableJS for answerZone
        sortableAnswerZone = Sortable.create(document.getElementById('answerZone'), {
                group: 'shared',
                animation: 0,    // Disable smooth animations
                easing: "linear",
                swapThreshold: 0.7,
                ghostClass: 'dragging', // Apply this class to the ghost element while dragging
                onAdd: function (evt) {
                        // Animate word box on drop
                        evt.item.classList.add('animate-drop');
                        setTimeout(() => evt.item.classList.remove('animate-drop'), 300);
                }
        });

        loadQuizTitlesAndIds(); // Load quiz options from Google Sheet

        // pageviews
        const pv = document.getElementById('pageviews');
            
        if (pv !== null) {
            // Get the pathname. If it's "/" leave it intact; if it ends with "/" (and isn’t just "/"), remove it.
            let uri = location.pathname;
            if (uri !== "/" && uri.endsWith("/")) {
                uri = uri.slice(0, -1);
            }
            // If on the homepage (empty or "/"), use "/" as the key.
            if (!uri) {
                uri = "/";
            }
            // Build the JSON endpoint URL
            const url = `https://linsnotes.goatcounter.com/counter/${encodeURIComponent(uri)}.json`;
                
            fetch(url)
                .then((response) => {
                    if (!response.ok) {
                        // If a 404 or any other error, return a default count of 0 (or another fallback)
                        return { count: "0" };
                    }
                    return response.json();
                })
                .then((data) => {
                    // Remove any whitespace from data.count
                    const count = data.count.replace(/\s/g, '');
                    // Format and display the count
                    pv.innerText = new Intl.NumberFormat().format(count);
                    pv.classList.remove('loading');
                })
                .catch((error) => {
                    // Fallback if something goes wrong
                    pv.innerText = '0';
                    pv.classList.remove('loading');
                });
        }
    });


    // Double-click Functions
    function setupDoubleClickHandlers() {
        // Use event delegation to handle double-clicks
        document.getElementById('wordContainer').addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('word-box')) {
                document.getElementById('answerZone').appendChild(e.target);
            }
        });

        document.getElementById('answerZone').addEventListener('dblclick', function(e) {
            if (e.target.classList.contains('word-box')) {
                // Remove the 'incorrect' class immediately when moved back via double-click
                e.target.classList.remove('incorrect');
                document.getElementById('wordContainer').appendChild(e.target);
            }
        });
    }

    // Core Quiz Functions
    async function loadSheetData(sheetId) {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv`;
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csv = await response.text();
            const workbook = XLSX.read(csv, {type: 'string'});
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) {
                 throw new Error('No sheet found in the workbook.');
            }
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
            window.quizTitle = rows[0][0]; // Extract cell A1 and store globally
            // Ensure rows is an array and has data
             if (!Array.isArray(rows) || rows.length <= 1) {
                console.warn('Sheet is empty or has only a header row.');
                return []; // Return empty array if no data after header
            }
            return rows.slice(1).map(row => row[0]).filter(cell => cell != null && cell.trim() !== ''); // Skip header row and filter out empty/null cells

        } catch (error) {
            console.error('Error loading sheet data:', error);
            Swal.fire({
                title: 'Error Loading Quiz',
                text: `Could not load quiz data. Please check the Quiz ID [${sheetId}] or network connection. Details: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#1a73e8'
            });
            return null; // Return null to indicate failure
        }
    }

    // Load Quiz Titles and IDs from Google Sheet
    async function loadQuizTitlesAndIds() {
        try {
            const url = `https://docs.google.com/spreadsheets/d/${QUIZ_LIST_SHEET_ID}/export?format=csv`;
            const response = await fetch(url);
             if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csv = await response.text();
            const workbook = XLSX.read(csv, {type: 'string'});
            const sheetName = workbook.SheetNames[0];
            if (!sheetName) {
                 throw new Error('No sheet found in the workbook for quiz list.');
            }
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});

            quizTitlesAndIds = rows.slice(1) // Skip header
                                  .map(row => ({ title: row[0], id: row[1] }))
                                  .filter(quiz => quiz.title && quiz.id); // Ensure both title and id exist

            populateQuizSelect();
        } catch (error) {
            console.error('Error loading quiz titles:', error);
            Swal.fire({
                title: 'Error',
                text: `Could not load the list of available quizzes. Details: ${error.message}`,
                icon: 'error',
                confirmButtonColor: '#1a73e8'
            });
             // Optionally disable the dropdown and built-in quiz button if list fails to load
            document.getElementById('quizSelect').disabled = true;
            document.querySelector('button[onclick="startSelectedQuiz()"]').disabled = true;
        }
    }

    function populateQuizSelect() {
        const selectElement = document.getElementById('quizSelect');
        selectElement.innerHTML = ''; // Clear existing options

        if (quizTitlesAndIds.length === 0) {
             const option = document.createElement('option');
             option.textContent = "No quizzes available";
             option.disabled = true;
             selectElement.appendChild(option);
             selectElement.disabled = true; // Disable select if empty
             document.querySelector('button[onclick="startSelectedQuiz()"]').disabled = true; // Disable button
             return;
        }

        // Add a default prompt option
        const defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "-- Select a Quiz --";
        defaultOption.disabled = true; // Make it non-selectable
        defaultOption.selected = true; // Make it the default display
        selectElement.appendChild(defaultOption);


        quizTitlesAndIds.forEach(quiz => {
            const option = document.createElement('option');
            option.value = quiz.id;
            option.textContent = quiz.title;
            selectElement.appendChild(option);
        });

        // Set the initial currentSheetId to the first available quiz ID if any, otherwise keep it empty
        // currentSheetId = quizTitlesAndIds.length > 0 ? quizTitlesAndIds[0].id : '';
        currentSheetId = ''; // Start with no selection

        // Add event listener to the select element to update currentSheetId
        selectElement.addEventListener('change', function() {
            currentSheetId = this.value; // Update currentSheetId when the selection changes
            document.getElementById('quizId').value = ''; // Clear any previously entered custom Quiz ID
            // Enable the "Start Built-in Quiz" button only when a valid quiz is selected
            document.querySelector('button[onclick="startSelectedQuiz()"]').disabled = !this.value;
        });

        // Initially disable the button until a selection is made
        // document.querySelector('button[onclick="startSelectedQuiz()"]').disabled = true;
    }

    // ADDED function to start quiz from dropdown selection
    function startSelectedQuiz() {
        if (!currentSheetId) {
             Swal.fire({
                title: 'No Quiz Selected',
                text: 'Please select a quiz from the dropdown list.',
                icon: 'warning',
                confirmButtonColor: '#1a73e8'
            });
            return;
        }
        startQuizFlow(currentSheetId);
    }


    async function startCustomQuiz() {
        const sheetId = document.getElementById('quizId').value.trim(); // Trim whitespace
        if (!sheetId) return Swal.fire({
            title: 'Missing Input',
            text: 'Please enter a Custom Quiz ID.',
            icon: 'warning',
            confirmButtonColor: '#1a73e8'
        });
        currentSheetId = sheetId; // Update currentSheetId for custom quiz as well
        startQuizFlow(sheetId);
    }

    async function startQuizFlow(sheetId) {
        // Show loading indicator
        Swal.fire({
            title: 'Loading Quiz',
            text: 'Please wait...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });

        const data = await loadSheetData(sheetId);

        if (data === null) { // Check if loading failed
             // Close loading indicator if loadSheetData handled the error popup - Swal.close();
            return; // Stop execution if data loading failed
        }

        if (!data || data.length === 0) {
             Swal.close();
             Swal.fire({
                title: 'Empty Quiz',
                text: 'The selected quiz appears to be empty or could not be loaded correctly.',
                icon: 'warning',
                confirmButtonColor: '#1a73e8'
            });
            return; // Stop if quiz data is empty
        }


        quizData = data.map(question => {
            // Ensure question is a string before splitting
            const questionText = String(question || '');
            // Calculate parts first (split by #, trim each, remove empty)
            const parts = questionText.split('#').map(p => p.trim()).filter(p => p);
            // Generate the 'correct' answer CONSISTENTLY by joining the cleaned parts with a single space
            const correctAnswerString = parts.join(' ');
            
            return {
                parts: parts,
                correct: correctAnswerString,
                shuffled: null
            };
        }).filter(q => q.parts.length > 0); // Filter out questions that became empty

        if (quizData.length === 0) {
             Swal.close();
             Swal.fire({
                title: 'Invalid Quiz Data',
                text: 'No valid questions found in the loaded quiz data.',
                icon: 'warning',
                confirmButtonColor: '#1a73e8'
            });
            return;
        }

        Swal.close(); // Close loading indicator *after* processing data

        questionAttempts = {};
        quizData.forEach((_, idx) => {
            questionAttempts[idx] = { attempts: 0, correct: false };
        });

        // Reset quiz state
        currentQuestion = 0;
        userData.attempts = [];
        userData.totalPoints = 0;
        pausedAt = 0;
        elapsedTime = 0;
        // Clear previous results if any
        document.getElementById('resultSummary').innerHTML = '';
        document.getElementById('resultsTable').innerHTML = '';


        showScreen('nameScreen');
    }

    function startQuiz() {
        userData.name = document.getElementById('userName').value.trim();
        if (!userData.name) return Swal.fire({
            title: 'Missing Input',
            text: 'Please enter your name',
            icon: 'warning',
            confirmButtonColor: '#1a73e8'
        });

        // Set up double-click handlers
        setupDoubleClickHandlers();

        showScreen('quizScreen');
        document.getElementById('quizTitleDisplay').innerText = window.quizTitle || '';
        loadQuestion();
        startTimer();
    }

    function loadQuestion() {
        // Ensure currentQuestion is within bounds
        if (currentQuestion >= quizData.length) {
            console.error("Attempted to load question beyond quiz length.");
            showResults(); // Go to results if out of questions
            return;
        }

        const question = quizData[currentQuestion];
        if (!question.shuffled) {
            question.shuffled = shuffle([...question.parts]);
        }

        // Update progress bar
        const progressPercentage = ((currentQuestion + 1) / quizData.length) * 100;
        document.getElementById('progressBar').style.width = `${progressPercentage}%`;

        document.getElementById('questionNumber').textContent =
            `Question ${currentQuestion + 1} of ${quizData.length}`;

        const wordContainer = document.getElementById('wordContainer');
        // Clear previous words carefully if using SortableJS
        while (wordContainer.firstChild) {
            wordContainer.removeChild(wordContainer.firstChild);
        }
        question.shuffled.forEach(word => {
             const wordBox = document.createElement('div');
             wordBox.className = 'word-box';
             wordBox.textContent = word;
             wordContainer.appendChild(wordBox);
        });


        // Clear answer zone carefully if using SortableJS
         const answerZone = document.getElementById('answerZone');
         while (answerZone.firstChild) {
            answerZone.removeChild(answerZone.firstChild);
        }

        // Re-enable confirm button if it was disabled
        document.querySelector('#quizScreen .btn-primary').disabled = false;
    }

    function startTimer() {
        clearInterval(timerInterval); // Clear any existing interval first
        if (pausedAt > 0) {
            // Resume timer
            userData.startTime = Date.now() - (pausedAt * 1000); // Adjust start time based on paused duration
            elapsedTime = pausedAt; // Restore elapsed time
            pausedAt = 0;
        } else {
            // Start new timer
            userData.startTime = Date.now();
            elapsedTime = 0; // Reset elapsed time for new question/start
        }

        document.getElementById('timer').textContent = elapsedTime; // Update display immediately
        timerPaused = false;

        timerInterval = setInterval(() => {
            if (!timerPaused) {
                // Calculate elapsed time based on the difference from the start time
                elapsedTime = Math.floor((Date.now() - userData.startTime) / 1000);
                document.getElementById('timer').textContent = elapsedTime;
            }
        }, 1000);
    }

    function pauseTimer() {
        if (!timerPaused) { // Only pause if not already paused
            timerPaused = true;
            pausedAt = elapsedTime; // Store the current elapsed time when paused
            // No need to clear interval here, just stop updating elapsedTime
        }
    }

    function resumeTimer() {
         if (timerPaused) { // Only resume if paused
            timerPaused = false;
            // Adjust startTime based on how long it was paused
            userData.startTime = Date.now() - (pausedAt * 1000);
            // The interval continues running, it will pick up the correct time difference
        }
    }
    function checkAnswer() {
        // Disable button to prevent multiple submissions
        const confirmButton = document.querySelector('#quizScreen .btn-primary');
        confirmButton.disabled = true;

        pauseTimer(); // Pause timer while checking/showing feedback

        const timeSpent = elapsedTime; // Use the time when paused
        const answerZone = document.getElementById('answerZone');
        const wordContainer = document.getElementById('wordContainer'); // Get word container too
        const userAnswerWords = [...answerZone.querySelectorAll('.word-box')]
                                .map(node => node.textContent.trim());
        const userAnswer = userAnswerWords.join(' ');

        // *** NEW: Check if the attempt is complete ***
        // An attempt is complete if the wordContainer is empty
        const isAttemptComplete = wordContainer.querySelectorAll('.word-box').length === 0;
        // *** END NEW ***

        const currentQuizItem = quizData[currentQuestion];
        const correctAnswer = currentQuizItem.correct;

        const isCorrect = userAnswer === correctAnswer;
        const currentAttemptRecord = questionAttempts[currentQuestion];
        currentAttemptRecord.attempts++;

        // Clear previous correct/incorrect styles from answer zone only
        answerZone.querySelectorAll('.word-box').forEach(box => {
            box.classList.remove('correct', 'incorrect');
        });

        let attemptIndex = userData.attempts.findIndex(a => a.question === currentQuestion + 1);

        if (isCorrect) {
            // --- CORRECT ANSWER LOGIC ---
            currentAttemptRecord.correct = true;
            const points = calculatePoints(timeSpent);

            const attemptData = {
                question: currentQuestion + 1,
                time: timeSpent,
                points,
                userAnswer,
                correctAnswer,
                attempts: currentAttemptRecord.attempts,
                attemptComplete: isAttemptComplete // *** ADDED FLAG ***
            };

            // Add or update the attempt in userData
            if (attemptIndex === -1) {
                userData.attempts.push(attemptData);
            } else {
                userData.attempts[attemptIndex] = attemptData;
            }

            Swal.fire({
                title: 'Correct!',
                text: `+${points} points`,
                icon: 'success',
                // ... (rest of Swal options)
            }).then(() => {
                // ... (rest of logic to move next)
                if (currentQuestion < quizData.length - 1) {
                    currentQuestion++;
                    pausedAt = 0; // Reset pause state for next question
                    loadQuestion();
                    startTimer(); // Restart timer for the new question
                } else {
                    showResults();
                }
            });

        } else {
            // --- INCORRECT ANSWER LOGIC ---

            // *** NEW: Only show "Incorrect" pop-up if the attempt was complete ***
            // If incomplete, just record it and move on or allow retry without the harsh 'Incorrect!' label initially.
            // Let's refine this: Always record the attempt, but the popup message can differ.
            // We still need to record the attempt data.

            const attemptData = {
                question: currentQuestion + 1,
                time: timeSpent,
                points: 0, // Incorrect answer gets 0 points
                userAnswer,
                correctAnswer,
                attempts: currentAttemptRecord.attempts,
                attemptComplete: isAttemptComplete // *** ADDED FLAG ***
            };

            // Update or add the attempt record regardless of completeness
            if (attemptIndex === -1) {
                userData.attempts.push(attemptData);
            } else {
                // Only update if the new attempt is 'more complete' or it's still incomplete
                // Or simply always update to reflect the last try state
                userData.attempts[attemptIndex] = attemptData; // Always update with the latest attempt info
            }

            // Highlight incorrect boxes *only if the attempt was complete* (otherwise it's just incomplete)
            if (isAttemptComplete) {
                const correctAnswerWords = correctAnswer.split(' ');
                const userWordBoxes = answerZone.querySelectorAll('.word-box');
                const incorrectBoxesToClear = [];

                userWordBoxes.forEach((box, index) => {
                    const userWord = box.textContent.trim();
                    const correctWordAtIndex = correctAnswerWords[index];
                    if (index >= correctAnswerWords.length || userWord !== correctWordAtIndex) {
                        box.classList.add('incorrect');
                        incorrectBoxesToClear.push(box);
                    }
                });

                setTimeout(() => {
                    incorrectBoxesToClear.forEach(box => {
                        if (box && box.parentElement === answerZone && box.classList.contains('incorrect')) {
                            box.classList.remove('incorrect');
                        }
                    });
                }, 5000);
            }

            // Show popup based on completeness
            const popupTitle = isAttemptComplete ? 'Incorrect!' : 'Incomplete Answer';
            const popupIcon = isAttemptComplete ? 'error' : 'warning';
            const popupHTML = isAttemptComplete ? "Would you like to try again?" : "You haven't used all the words. Would you like to try again?";

            Swal.fire({
                title: popupTitle, // Dynamic title
                html: popupHTML,   // Dynamic message
                icon: popupIcon,     // Dynamic icon
                showCancelButton: true,
                confirmButtonText: 'Try Again',
                cancelButtonText: 'Next Question',
                confirmButtonColor: '#1a73e8',
                cancelButtonColor: '#ef4444',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // User wants to try again
                    resumeTimer();
                    confirmButton.disabled = false;
                    // Ensure incorrect styling is cleared if they retry an incomplete attempt
                    if (!isAttemptComplete) {
                        answerZone.querySelectorAll('.word-box').forEach(box => box.classList.remove('incorrect'));
                    }
                } else {
                    // User wants to move to the next question
                    answerZone.querySelectorAll('.word-box.incorrect').forEach(box => {
                        box.classList.remove('incorrect');
                    });

                    if (currentQuestion < quizData.length - 1) {
                        currentQuestion++;
                        pausedAt = 0;
                        loadQuestion();
                        startTimer();
                    } else {
                        showResults();
                    }
                }
            });
        }
    }


    // Utility functions
    function calculatePoints(seconds) {
        // const brackets = [[5,10],[10,9],[15,8],[20,7],[25,6],[30,5],[35,4],[40,3],[60,2],[Infinity,1]];
        const brackets = [[10,10],[20,9],[30,8],[40,7],[50,6],[60,5],[70,4],[80,3],[90,2],[Infinity,1]];
        for (const [max, points] of brackets) {
            if (seconds <= max) {
                return points;
            }
        }
        return 0; // Should not happen with Infinity, but good practice
    }


    function showResults() {
        clearInterval(timerInterval);
        showScreen('resultsScreen');

        // Calculate total points (no change needed here)
        userData.totalPoints = userData.attempts.reduce((sum, a) => sum + a.points, 0);
        const correctCount = userData.attempts.filter(a => a.points > 0).length;

        // Get completion timestamp  // <--- UNCOMMENTED
        const completionDate = new Date(); // <--- UNCOMMENTED
        const day = completionDate.getDate().toString().padStart(2, '0'); // <--- UNCOMMENTED
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']; // <--- UNCOMMENTED
        const month = monthNames[completionDate.getMonth()]; // <--- UNCOMMENTED
        const year = completionDate.getFullYear(); // <--- UNCOMMENTED
        const hours = completionDate.getHours().toString().padStart(2, '0'); // <--- UNCOMMENTED
        const minutes = completionDate.getMinutes().toString().padStart(2, '0'); // <--- UNCOMMENTED
        const seconds = completionDate.getSeconds().toString().padStart(2, '0'); // <--- UNCOMMENTED
        const completionTimestamp = `${day} ${month} ${year}, ${hours}:${minutes}:${seconds}`; // <--- UNCOMMENTED

        // Update the resultSummary with improved styling // <--- UNCOMMENTED
        document.getElementById('resultSummary').innerHTML = `
            <div class="result-stat">
                <i class="fas fa-user"></i>
                <span><strong>Name:</strong> ${userData.name || 'N/A'}</span>
            </div>
            <div class="result-stat">
                <i class="fas fa-calendar-check"></i>
                <span><strong>Completed:</strong> ${completionTimestamp}</span>
            </div>
            <div class="result-stat">
                <i class="fas fa-book"></i>
                <span><strong>Quiz Title:</strong> ${window.quizTitle || 'N/A'}</span>
            </div>
            <div class="result-stat">
                <i class="fas fa-trophy"></i>
                <span><strong>Total Score:</strong> ${userData.totalPoints} points</span>
            </div>
            <div class="result-stat">
                <i class="fas fa-check-circle" style="color: var(--success);"></i>
                <span><strong>Correct Answers:</strong> ${correctCount} / ${quizData.length}</span>
            </div>
        `; 


        const table = document.getElementById('resultsTable');
        let tableHTML = `
            <thead>
                <tr>
                    <th>#</th>
                    <th>Time (s)</th>
                    <th>Points</th>
                    <th>Attempts</th>
                    <th>Your Answer</th>
                    <th>Correct Answer</th>
                </tr>
            </thead>
            <tbody>`;

        for (let i = 0; i < quizData.length; i++) {
            const questionNum = i + 1;
            const attempt = userData.attempts.find(a => a.question === questionNum);
            const originalQuestionData = quizData[i]; // Get original data for the correct answer fallback

            if (attempt) {
                // *** NEW: Conditional display based on attemptComplete ***
                const displayCorrectAnswer = attempt.attemptComplete || attempt.points > 0; // Show if complete OR if they got it right anyway (edge case?)
                const correctAnswerText = displayCorrectAnswer
                                          ? attempt.correctAnswer
                                          : '<span style="color: var(--warning);">Please try again to review</span>';
                const userAnswerText = attempt.attemptComplete || attempt.points > 0
                                       ? (attempt.userAnswer || 'N/A') // Show their answer if attempt was complete
                                       : '<i>Incomplete</i>'; // Show 'Incomplete' if not complete

                const rowClass = attempt.points > 0 ? 'table-success' : (displayCorrectAnswer ? 'table-danger-light' : ''); // Add danger class only if complete but wrong

                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${attempt.question}</td>
                        <td>${attempt.time}</td>
                        <td>${attempt.points}</td>
                        <td>${attempt.attempts}</td>
                        <td style="color: ${attempt.points > 0 ? 'inherit' : (displayCorrectAnswer ? 'var(--danger)' : 'inherit')};">${userAnswerText}</td>
                        <td>${correctAnswerText}</td>
                    </tr>
                `;
                // *** END NEW ***
            } else {
                // Question skipped or not reached
                tableHTML += `
                    <tr>
                        <td>${questionNum}</td>
                        <td>-</td>
                        <td>0</td>
                        <td>${questionAttempts[i]?.attempts || 0}</td>
                        <td><i>Not Answered</i></td>
                        <td><span style="color: var(--warning);">Please try again to review</span></td>
                    </tr>
                `;
            }
        }

        tableHTML += `</tbody>`;
        table.innerHTML = tableHTML;
    }
    


    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
             targetScreen.classList.add('active');
        } else {
             console.error(`Screen with ID ${screenId} not found.`);
             // Optionally default to landing screen
             document.getElementById('landingScreen').classList.add('active');
        }


        // Show/hide header and footer based on screen
        const showHeaderFooter = (screenId !== 'quizScreen');
        document.querySelector('.app-header').style.display = showHeaderFooter ? 'block' : 'none';
        document.querySelector('.app-footer').style.display = showHeaderFooter ? 'block' : 'none';
    }

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function screenshotResults() {
        // Show loading indicator
        Swal.fire({
            title: 'Generating Screenshot',
            text: 'Please wait...',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });

        const resultsElement = document.querySelector('#resultsScreen .card'); // Target the card for better framing

        html2canvas(resultsElement, {
             scale: 2, // Increase resolution for better quality
             useCORS: true // If any external images/fonts are used indirectly
             }).then(canvas => {
            Swal.close();
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `LanguagePuzzle-Results-${userData.name || 'User'}-${timestamp}.png`;
            link.href = canvas.toDataURL("image/png"); // Use PNG for better quality
            link.click();

            Swal.fire({
                title: 'Success!',
                text: 'Your results screenshot has been downloaded.',
                icon: 'success',
                confirmButtonColor: '#1a73e8',
            });
        }).catch(err => {
             Swal.close();
             console.error("Screenshot error:", err);
             Swal.fire({
                title: 'Error',
                text: 'Could not generate screenshot.',
                icon: 'error',
                confirmButtonColor: '#1a73e8',
             });
        });
    }

    function reviewQuestions() {
        Swal.fire({
            title: 'Try Again?',
            text: 'Do you want to restart the same quiz? Your previous results for this session will be cleared.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, Restart Quiz',
            cancelButtonText: 'No, Go Home',
            confirmButtonColor: '#1a73e8',
            cancelButtonColor: '#6b7280',
            reverseButtons: true // Puts 'Yes' on the right
        }).then((result) => {
            if (result.isConfirmed) {
                // Restart the same quiz using the stored currentSheetId
                if (!currentSheetId) {
                     Swal.fire("Error", "Cannot determine which quiz to restart.", "error");
                     showScreen('landingScreen'); // Go back home if ID is lost
                     return;
                }
                // Re-use startQuizFlow to reset and load, then go to name screen again
                 startQuizFlow(currentSheetId);
                 // Note: startQuizFlow now handles resetting state and goes to nameScreen

            } else if (result.dismiss === Swal.DismissReason.cancel) {
                 // User clicked 'No, Go Home'
                 // Reset necessary states before going home
                 currentQuestion = 0;
                 quizData = [];
                 userData = { name: '', startTime: 0, attempts: [], totalPoints: 0 };
                 timerInterval = null;
                 pausedAt = 0;
                 elapsedTime = 0;
                 currentSheetId = ''; // Clear selected sheet ID
                 document.getElementById('quizId').value = ''; // Clear custom ID input
                 document.getElementById('quizSelect').selectedIndex = 0; // Reset dropdown
                 document.querySelector('button[onclick="startSelectedQuiz()"]').disabled = true; // Disable built-in start button again

                 showScreen('landingScreen'); // Go back to the beginning
            }
        });
    }
</script>
</body>
</html>
